# 计算机网络复习笔记

## 网络架构

### 客户端-服务器架构（主从式架构）
C/S架构，是一种网络架构，它把客户端（通常是一个采用图形用户界面的程序）与服务器区分开来。每一个客户端软件的实例都可以向一个服务器或应用程序服务器发出请求。服务器可以是有状态或者无状态的。无状态的服务器不会保留任何两个请求之间的信息，有状态服务器会记住请求之间的信息。静态HTML页面服务器是一个无状态服务器的例子，Apache Tomcat是一个有状态服务器。\
服务端的特征：被动的角色（从）；等待来自客户端的请求；处理请求并传回结果。\
客户端的特征：主动的角色（主）；发送请求；等待直到收到响应。

### 浏览器-服务器结构
简称B/S结构，与C/S结构不同，其客户端不需要安装专门的软件，只需要浏览器即可，浏览器通过Web服务器与数据库进行交互，可以方便的在不同平台下工作。

### 对等式网络
简称P2P结构，点对点技术，是无中心服务器、依靠用户群交换信息的互联网体系，它的作用在于，减低以往网路传输中的节点，以降低资料遗失的风险。与有中心服务器的中央网络系统不同，对等网络的每个用户端既是一个节点，也有服务器的功能，任何一个节点无法直接找到其他节点，必须依靠其户群进行信息交流。

## 服务器
一个管理资源并为用户提供服务的计算机软件，通常分为文件服务器（能使用户在其它计算机访问文件），数据库服务器和应用程序服务器。\
运行以上软件的计算机，或称为网络主机。\
服务器通常以网络作为介质，既可以通过局域网对内提供服务，也可以通过广域网对外提供服务。

### 文件服务器
一种专供其他电脑检索文件和存储的特殊电脑。文件服务器通常比一般的个人电脑拥有更大的存储容量，并具有一些其他的功能，如磁盘镜像、多个网络接口卡、热备援多电源供应器。

### 数据库服务器
由运行在局域网中的一台或多台计算机和数据库管理系统软件共同构成，数据库服务器为客户应用程序提供数据服务。

### 域名服务器
提供域名服务协议的程序或服务器。它可以将人类可识别的标识符，映射为系统内部通常为数字形式的标识码。

#### DNS寻址过程
1. 客户机发出查询请求，在本地缓存查找，没有找到就会将请求发送给客户机DNS服务器
1. 客户机DNS服务器缓存中没有找到就会将请求发送给根域名DNS服务器
1. 根域名DNS服务器解析客户机请求的根域部分，它把包含的下一级的DNS服务器的地址返回给客户机DNS服务器
1. 客户机DNS服务器根据返回的信息接着访问下一级的DNS服务器
1. 递归查询直到最后在有目标域名的服务器上面得到相应的IP信息
1. 客户机DNS服务器会将查询结果返回给客户机
1. 客户机根据得到的IP信息访问目标主机，完成解析过程

### 网页服务器
一台负责提供网页的计算机，主要是各种编程语言构建而成，透过HTTP协议传给客户端（一般是指网页浏览器）。每一个网页服务器程序都需要从网络接受HTTP请求，然后提供HTTP回复给请求者。HTTP回复一般包含一个HTML文件，有时也可以包含纯文本文件、图像或其他类型的文件。

### 应用程序服务器
用于为应用程序提供安全、数据、事务支持、负载平衡大型分布式系统管理等服务。

### 代理服务器
允许一个网络终端（一般为客户端）通过这个服务与另一个网络终端（一般为服务器）进行非直接的连接。一些网关、路由器等网络设备具备网络代理功能。一般认为代理服务有利于保障网络终端的隐私或安全，防止攻击。代理服务器的基本行为就是接收客户端发送的请求后转发给其他服务器。代理不改变请求URI，会直接发送给前方持有资源的目标服务器。持有资源实体的服务器被称为源服务器。从源服务器返回的响应经过代理服务器后再传给客户端。

#### 功能
1. 提高访问速度：通常代理服务器都设置一个较大的缓冲区，当有外界的信息通过时，同时也将其保存到缓冲区中，当其他用户再访问相同的信息时， 则直接由缓冲区中取出信息，传给用户，以提高访问速度。
1. 控制对内部资源的访问：如某大学FTP（前提是该代理地址在该资源的允许访问范围之内），使用教育网内地址段免费代理服务器，就可以用于对教育网开放的各类FTP下载上传，以及各类资料查询共享等服务。
1. 过滤内容：例如限制对特定计算机的访问，将一种语言的数据翻译成另一种语言，或是防御代理服务器两边的攻击性访问。
1. 隐藏真实IP：上网者也可以通过代理服务器隐藏自己的IP，免受攻击。
1. 突破自身IP访问限制：访问国外站点。
1. 突破内容过滤机制限制：访问被过滤网站。

#### 种类
1. FTP代理服务器：主要用于访问FTP服务器，一般有上传、下载以及缓存功能。端口一般为21、2121等。
1. HTTP代理服务器：主要用于访问网页，一般有内容过滤和缓存功能。端口一般为80、8080、3128等。
1. SSL/TLS代理：主要用于访问加密网站，一般有SSL或TLS加密功能（最高支持128位加密强度）。端口一般为443。
1. POP3/SMTP代理：主要用于POP3/SMTP方式收发邮件，一般有缓存功能。端口一般为110/25。
1. RTSP代理：主要用于Realplayer访问Real流媒体服务器，一般有缓存功能。端口一般为554。
1. Telnet代理：主要用于telnet远程控制（黑客入侵计算机时常用于隐藏身份）。端口一般为23。
1. SOCKS代理：只是单纯传递数据包，不关心具体协议和用法，所以速度快很多。一般有缓存功能。端口一般为1080。

#### 反向代理
服务器根据客户端的请求，从其关系的一组或多组后端服务器（如Web服务器）上获取资源，然后再将这些资源返回给客户端，客户端只会得知反向代理的IP地址，而不知道在代理服务器后面的服务器集群的存在。反向代理的主要作用为：
1. 对客户端隐藏服务器（集群）的IP地址
1. 安全：作为应用层防火墙，为网站提供对基于Web的攻击行为（例如DoS/DDoS）的防护，更容易排查恶意软件等
1. 为后端服务器（集群）统一提供加密和SSL加速（如SSL终端代理）
1. 负载均衡，若服务器集群中有负荷较高者，反向代理通过URL重写，根据连线请求从负荷较低者获取与所需相同的资源或备援
1. 对于静态内容及短时间内有大量访问请求的动态内容提供缓存服务
1. 对一些内容进行压缩，以节约带宽或为网络带宽不佳的网络提供服务
1. 减速上传
1. 为在私有网络下（如局域网）的服务器集群提供NAT穿透及外网发布服务
1. 提供HTTP访问认证

#### 分布式代理服务器
利用私立的域名解释系统，让相应的代理服务器客户端自动以安全链接连接上相应的多台代理服务器服务端，从而实现相应的代理功能。或通过特定的分布式网络，将客户端与相应的出口端创建成虚拟的路由网络，让不同的数据包通过该网络的不同节点和不同出口与外界链接。

## 网络概念模型

### 物理层
物理层在局部局域网上传送数据帧 Data Frame，它负责管理计算机通信设备和网络媒体之间的互通。包括了针脚、电压、线缆规范、集线器、中继器、网卡、主机接口卡等。

### 数据链路层
数据链路层负责网络寻址、错误侦测和改错。当表头和表尾被加至数据包时，会形成帧。数据链表头是包含了物理地址和错误侦测及改错的方法。数据链表尾是一串指示数据包末端的字符串。分为两个子层：逻辑链路控制子层和介质访问控制子层。

### 网络层
网络层决定数据的路径选择和转寄，将网络表头加至数据包，以形成分组。网络表头包含了网络数据。例如：互联网协议（IP）等。

#### IP
IPv4使用32位（4字节）地址，IPv6采用128位的地址。

#### ICMP
它用于网际协议（IP）中发送控制消息，提供可能发生在通信环境中的各种问题反馈。通过这些信息，使管理者可以对所发生的问题作出诊断，然后采取适当的措施解决。

##### ping
它用来测试数据包能否透过IP协议到达特定主机。原理：向目标主机传出一个ICMP的请求回显数据包，并等待接收回显回应数据包。程序会按时间和成功响应的次数估算丢包率和网络时延。

##### traceroute
它可显示数据包在IP网络经过的路由器的IP地址。原理：程序是利用增加存活时间（TTL）值来实现其功能的。每当数据包经过一个路由器，其存活时间就会减1。当其存活时间是0时，主机便取消数据包，并发送一个ICMP TTL数据包给原数据包的发出者。

### 传输层
传输层把传输表头加至数据以形成数据包。传输表头包含了所使用的协议等发送信息。例如：传输控制协议（TCP）等。

#### UDP
简单的面向数据报的通信协议。应用：DNS，DHCP，RIP等/
UDP只提供数据的不可靠传递，它一旦把应用程序发给网络层的数据发送出去，就不保留数据备份。由于UDP缺乏可靠性且属于无连接协议，所以应用程序通常必须容许一些丢失、错误或重复的数据包。一些应用程序不太需要可靠性机制，甚至可能因为引入可靠性机制而降低性能，所以它们使用UDP这种缺乏可靠性的协议。/
UDP报头仅包括4个字段：来源连接端口，目的连接端口，报文长度，校验和。

#### TCP
面向连接的、可靠的、基于字节流的传输层通信协议。应用：HTTP等/
应用层向TCP层发送用于网间传输的、用8位字节表示的数据流，然后TCP把数据流分割成适当长度的报文段，之后TCP把结果包传给IP层，由它来通过网络将包传送给接收端实体的TCP层。TCP为了保证不发生丢包，就给每个包一个序号，同时序号也保证了传送到接收端实体的包的按序接收。然后接收端实体对已成功收到的包发回一个相应的确认信息（ACK）；如果发送端实体在合理的往返时延（RTT）内未收到确认，那么对应的数据包就被假设为已丢失并进行重传。/

##### 三次握手
1. 客户端通过向服务器端发送一个SYN包来创建一个主动打开，作为三次握手的一部分。客户端把这段连接的序号设定为随机数A。
1. 服务器端应当为一个合法的SYN包回送一个SYN-ACK包。ACK的确认码应为A+1，SYN/ACK包本身又有一个随机产生的序号B。
1. 最后，客户端再发送一个ACK包。此时包的序号被设定为A+1，而ACK的确认码则为B+1。当服务端收到这个ACK的时候，就完成了三次握手，并进入了连接创建状态。

- 情景1:SYN-ACK包丢失，服务器端重发SYN-ACK包，失败N次后关闭连接。
- 情景2:ACK包丢失，客户端开始向服务器端发送消息，Server端将以RST包（关闭异常连接）响应。
- 情景3:服务器端接到了客户端发的SYN包后回了SYN-ACK包后客户端掉线了，等同于情景1。

##### 四次挥手
1. 主动方发送一个FIN包，表示自己已经没有数据可以发送了，但是仍然可以接受数据，发送完毕后，进入FIN-WAIT-1状态。
1. 被动方收到主动方的FIN包，发回一个确认包，表明自己接受到了关闭连接的请求，但还没有准备好关闭连接（还有数据需要发送）。发送完毕后，被动方进入CLOSE-WAIT状态，主动方接收到确认包之后，进入FIN-WAIT-2状态，等待被动方关闭连接。
1. 被动方准备好关闭连接时（发送完所有数据），向主动方发送FIN包，并进入LAST-ACK状态，等待来自主动方的最后一个ACK包。
1. 主动方接收到来自被动方的关闭请求，发送一个确认包，并进入TIME-WAIT状态，等待可能出现的要求重传的ACK包。
1. 被动方接收到这个确认包之后，关闭连接，进入CLOSED状态。
1. 主动方等待了某个固定时间，认为被动方已经正常关闭连接，于是自己也关闭连接，进入CLOSED状态。

- 情景1:最后一个ACK丢失，被动方重发FIN，如果在TIME-WAIT状态结束前有一个新的FIN到达了，主动方就会发送一个新的ACK，并重新设置计时器。

##### 状态编码
- LISTEN：服务器等待从任意远程TCP端口的连接请求。
- SYN-SENT：客户在发送连接请求后等待匹配的连接请求。
- SYN-RECEIVED：服务器已经收到并发送同步（SYNC）信号之后等待确认（ACK）请求。
- ESTABLISHED：服务器与客户的连接已经打开，收到的数据可以发送给用户。数据传输步骤的正常情况。此时连接两端是平等的。这称作全连接。
- FIN-WAIT-1：主动关闭端发出FIN请求包，表示本方的数据发送全部结束，等待TCP连接另一端的ACK确认包或FIN&ACK请求包。
- FIN-WAIT-2：主动关闭端在FIN-WAIT-1状态下收到ACK确认包，进入等待远程TCP的连接终止请求的半关闭状态。这时可以接收数据，但不再发送数据。
- CLOSE-WAIT：被动关闭端接到FIN后，就发出ACK以回应FIN请求，并进入等待本地用户的连接终止请求的半关闭状态。这时可以发送数据，但不再接收数据。
- LAST-ACK：被动关闭端全部数据发送完成之后，向主动关闭端发送FIN，进入等待确认包的状态。
- TIME-WAIT：主动关闭端接收到FIN后，就发送ACK包，等待足够时间以确保被动关闭端收到了终止请求的确认包。
- CLOSED：完全没有连接。

##### 流量控制
使用滑动窗口协议实现流量控制。接收方在“接收窗口”域指出还可接收的字节数量。发送方在没有新的确认包的情况下至多发送“接收窗口”允许的字节数量。接收方可修改“接收窗口”的值。当接收方宣布接收窗口的值为0，发送方停止进一步发送数据，开始了“保持定时器”，以避免因随后的修改接收窗口的数据包丢失使连接的双侧进入死锁，发送方无法发出数据直至收到接收方修改窗口的指示。

##### 拥塞控制
拥塞控制是发送方根据网络的承载情况控制分组的发送量，以获取高性能又能避免拥塞崩溃。发送方与接收方根据确认包或者包丢失的情况，以及定时器，估计网络拥塞情况，从而修改数据流的行为，这称为拥塞控制或网络拥塞避免。拥塞控制算法：慢开始、拥塞避免、快速重传、快速恢复。

- 慢启动：每次TCP接收窗口收到确认时都会以指数增长。为了保持对慢启动的控制，发送方为每一个连接维持一个慢启动阈值。
- 情景1：一旦慢启动超过了阈值，窗口从指数增长切换为线性增长。
- 情景2：一旦发生丢包，阈值设为当前拥塞窗口的一半，整个过程重新启动。
- 快恢复：发生丢包时，阈值设为当前拥塞窗口的一半，窗口从阈值开始线性增长。

#### KCP
- 具有可靠性的传输层ARQ协议，为了解决在网络拥堵情况下TCP协议速度慢的问题。KCP力求在保证可靠性的情况下提高传输速度。KCP协议没有规定下层传输协议，一般用UDP作为下层传输协议，KCP层协议的数据包在UDP数据报文的基础上增加控制头。
- 为了提供可靠性，KCP采用了重传机制。KCP为每个分片分配一个唯一标识，接收方收到一个包后告知发送方接到的包的序号，发送方接到确认后再继续发送。而如果发送方在一定时间内（超时重传时间）没有接到确认，就说明数据包丢失了，发送方需要重传丢失的数据包，所以发送方会把待确认的数据缓存起来，方便重传。
- 当网络拥堵严重时，会发生丢包，丢包发生时KCP为了保证可靠性需要重传数据。而发送方需要判断什么时候发生了丢包，以及丢了哪些包。为了解决这个问题，发送方为缓存队列中的每个包设置了包序号和超时重传时间。当检测到当前时间超过了分片的超时重传时间，该分片还没有得到确认时就会触发该分片的超时重传。
- 停等的重传机制发送一个包后必须等待确认后再发下一个包，传输速度较慢，所以为了提高发送速度，发送方可以不必再每发送一个包后就进行等待确认，而是可以发送多个包出去，然后等待接收方一一确认。由于接收方不可能同时处理无限多的数据，因此接收方通过滑动窗口限制发送方在未收到确认之前只能发送wnd大小的数据。
- 丢包发生时，由于滑动窗口的存在，假设第n个包丢失了，但是此时n+1，n+2号包却已经传输成功了，此时最好只重传丢失的n号包，而不重传成功传输的n+1，n+2号包,这个机制叫做选择重传。当网络实在很拥堵的时候，KCP会通过引入了拥塞窗口限制发送方发送的数据量。

##### 常见问题
1. TCP为什么要建立连接：提供可靠，稳定的传输。
1. TCP为什么是可靠的：提供了确认和重传的机制；消息根据序列号排序，保证有序性；提供流量控制和拥塞控制。
1. TCP有哪些应用场景：文件传输、邮件传输等。

### 应用层
应用层提供为应用软件而设的接口，以设置与另一应用软件之间的通信。例如：HTTP，HTTPS，FTP，TELNET，SSH，SMTP，POP3等。

#### HTTP
一个客户端（用户）和服务端（网站）之间请求和应答的标准。请求方法：GET，POST，PUT，DELETE，HEAD等。请求信息：请求行（方法+资源路径+协议）+请求头+空行+消息体。默认使用端口：80。

##### GET
向指定的资源发出“显示”请求。使用GET方法应该只用在读取数据，而不应当被用于产生“副作用”的操作中。

##### POST
向指定资源提交数据，请求服务器进行处理（例如提交表单或者上传文件）。数据被包含在请求本文中。这个请求可能会创建新的资源或修改现有资源，或二者皆有。

##### PUT
向指定资源位置上传其最新内容。

##### DELETE
请求服务器删除URI所标识的资源。

##### HEAD
与GET方法一样，都是向服务器发出指定资源的请求。只不过服务器将不传回资源的本文部分。

##### 幂等性
假如在不考虑诸如错误或者过期等问题的情况下，若干次请求的副作用与单次请求相同或者根本没有副作用，那么这些请求方法就能够被视作幂等的。POST方法不是幂等的。

##### 状态码
1. 1xx消息——请求已被服务器接收，继续处理
1. 2xx成功——请求已成功被服务器接收、理解、并接受
1. 3xx重定向——需要后续操作才能完成这一请求
1. 4xx请求错误——请求含有词法错误或者无法被执行
1. 5xx服务器错误——服务器在处理某个正确请求时发生错误

##### 持续连接
使用同一个TCP连接来发送和接收多个HTTP请求/应答，而不是为每一个新的请求/应答打开新的连接的方法。
1. 减少了后续请求的延迟（无需再进行握手）
1. 降低拥塞控制（TCP连接减少了）
1. 较少的CPU和内存的使用（由于同时打开的连接的减少了）
1. 允许请求和应答的HTTP管线化（多个HTTP请求整批提交的技术，而在发送过程中不需先等待服务器的回应。注：只有幂等的请求可以使用管线化）
1. 报告错误无需关闭TCP连接

##### Cookie
Cookie是用来绕开HTTP无状态性的手段之一。服务器可以设置或读取Cookies中包含信息，借此维护用户跟服务器会话中的状态。/
Cookie总是保存在客户端中，按在客户端中的存储位置，可分为内存Cookie和硬盘Cookie。/
内存Cookie由浏览器维护，保存在内存中，浏览器关闭后就消失了，其存在时间是短暂的。硬盘Cookie保存在硬盘里，有一个过期时间，除非用户手工清理或到了过期时间，硬盘Cookie不会被删除，其存在时间是长期的。缺点：/
1. Cookie会被附加在每个HTTP请求中，所以无形中增加了流量。
1. 由于在HTTP请求中的Cookie是明文传递的，所以安全性成问题。
1. Cookie的大小限制在4KB左右，对于复杂的存储需求来说是不够用的。

##### Session
Session是服务端用来跟踪用户状态的一个数据结构，Session可以放在文件、数据库或内存中。Session有一个唯一标识SessionID，通过Cookie传递给客户端，通过Session可以进行有状态的会话。

##### HTTPS
在不安全的网络上创建一个安全信道，并可在使用适当的加密包和服务器证书可被验证且可被信任时，对窃听和中间人攻击提供合理的防护。HTTPS并不是一个单独的协议，而是对工作在一加密连接（TLS或SSL）上的常规HTTP协议的称呼。默认使用端口：443。工作原理：
1. 客户端发起HTTPS请求。
1. 服务端生成一对密钥（公钥+私钥），发送证书（公钥+其他信息）。
1. 客户端解析证书，生成会话密钥，用公钥加密发送给服务端。
1. 服务端用私钥解密信息，之后双方通过会话密钥通信。

##### Restful API
1. 总是使用HTTPS协议。
1. 每个网址代表一种资源，网址中不能有动词，只能有名词，而且所用的名词往往与数据库的表格名对应。
1. 对于资源的具体操作类型，由HTTP动词表示。
1. 过滤信息设计。例：?limit=10：指定返回记录的数量。
1. 服务器向用户返回的状态码，提示信息与错误处理。如果状态码是4xx，就应该向用户返回出错信息。
1. 服务器返回的数据格式，应该尽量使用JSON。

##### 常见问题
1. HTTP与HTTPS的区别：HTTP协议传输的数据都是未加密的；HTTPS协议是可进行加密传输、身份认证的网络协议。
1. 为什么要用会话密钥：对称加密算法的速度比非对称加密快；会话密钥在每次使用完后都可以丢弃，不容易被追踪。
